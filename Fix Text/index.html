<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ sửa lỗi encoding & Watermark</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }
        
        textarea, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        textarea {
            min-height: 150px;
        }
        
        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .buttons {
            text-align: center;
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .clear-btn {
            background: linear-gradient(45deg, #e53e3e, #c53030);
        }
        
        .copy-btn {
            background: linear-gradient(45deg, #38a169, #2f855a);
        }
        
        .watermark-btn {
            background: linear-gradient(45deg, #ed8936, #dd6b20);
        }
        
        .status {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: 600;
        }
        
        .success {
            background: #c6f6d5;
            color: #2f855a;
            border: 1px solid #9ae6b4;
        }
        
        .info {
            background: #bee3f8;
            color: #2b6cb0;
            border: 1px solid #90cdf4;
        }
        
        .watermark-section {
            background: #fff7ed;
            border: 2px solid #fed7aa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .watermark-section h3 {
            color: #c05621;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Công cụ sửa lỗi encoding & Watermark</h1>
        
        <div class="input-group">
            <label for="input">Nhập văn bản cần sửa:</label>
            <textarea id="input" placeholder="Dán văn bản có lỗi encoding vào đây..."></textarea>
        </div>
        
        <div class="buttons">
            <button onclick="fixText()">Sửa lỗi encoding</button>
            <button onclick="clearText()" class="clear-btn">Xóa</button>
            <button onclick="copyResult()" class="copy-btn">Copy kết quả</button>
        </div>
        
        <div id="status"></div>
        <div id="status-watermark"></div>
        
        <div class="input-group">
            <label for="output">Kết quả sau khi sửa:</label>
            <textarea id="output" readonly placeholder="Kết quả sẽ hiển thị ở đây..."></textarea>
        </div>
        
        <div id="changes-log" style="display: none;">
            <div class="input-group">
                <label>Chi tiết thay đổi:</label>
                <div id="changes-content" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 14px;"></div>
            </div>
        </div>
        
        <!-- WATERMARK SECTION -->
        <div class="watermark-section">
            <h3>Watermark</h3>
            
            <div class="input-group">
                <label for="watermark-text">Nội dung watermark:</label>
                <input type="text" id="watermark-text" placeholder="VD: Bản quyền thuộc về ABC" value="Nguồn: Tài liệu nội bộ">
            </div>
            
            <div class="input-group">
                <label for="watermark-count">Số lượng watermark:</label>
                <input type="number" id="watermark-count" min="1" max="50" value="5" style="width: 100px;">
            </div>
            
            <div class="buttons">
                <button onclick="addWatermark()" class="watermark-btn">Thêm Watermark</button>
            </div>
        </div>
    </div>

    <script>
        // Bản đồ các ký tự bị lỗi encoding
        const charMap = {
            '⼉': '儿', '⻝': '食', '⼦': '子', '⻔': '门', '⽤': '用', '⽅': '方', '⼜': '又', '⼀': '一',
            '⼗': '十', '⼤': '大', '⼈': '人', '⼊': '入', '⼋': '八', '⼒': '力', '⼑': '刀', '⼥': '女',
            '⼩': '小', '⼯': '工', '⼰': '己', '⼱': '巾', '⼲': '干', '⼴': '广', '⼸': '弓', '⼼': '心',
            '⼿': '手', '⽀': '支', '⽂': '文', '⽇': '日', '⽉': '月', '⽊': '木', '⽔': '水', '⽕': '火',
            '⽗': '父', '⽚': '片', '⽛': '牙', '⽜': '牛', '⽝': '犬', '⽟': '玉', '⽡': '瓦', '⽢': '甘',
            '⽣': '生', '⽥': '田', '⽩': '白', '⽪': '皮', '⽫': '皿', '⽬': '目', '⽯': '石', '⽰': '示',
            '⽲': '禾', '⽳': '穴', '⽴': '立', '⽵': '竹', '⽶': '米', '⽷': '糸', '⽹': '网', '⽺': '羊',
            '⽻': '羽', '⽼': '老', '⽽': '而', '⽿': '耳', '⾁': '肉', '⾂': '臣', '⾃': '自', '⾄': '至',
            '⾆': '舌', '⾈': '舟', '⾊': '色', '⾍': '虫', '⾎': '血', '⾏': '行', '⾐': '衣', '⾓': '角',
            '⾔': '言', '⾕': '谷', '⾖': '豆', '⾙': '贝', '⾚': '赤', '⾛': '走', '⾜': '足', '⾝': '身',
            '⾞': '车', '⾟': '辛', '⾨': '门', '⾦': '金', '⾧': '长', '⾬': '雨', '⾮': '非', '⾯': '面',
            '⾷': '食', '⾸': '首', '⾹': '香', '⾻': '骨', '⾼': '高', '⾥': '里', '⽆': '无', '⻢': '马',
            '⻅': '见', '⻆': '角', '⻩': '黄'
        };

        // ======= WATERMARK FUNCTIONS =======
        
        // Zero-width characters
        const zeroWidth = {
            zwj: '\u200D',     // Zero Width Joiner
            zwnj: '\u200C',    // Zero Width Non-Joiner
            zwsp: '\u200B',    // Zero Width Space
            lrm: '\u200E',     // Left-to-Right Mark
            rlm: '\u200F',     // Right-to-Left Mark
        };
        
        // Unicode variation selectors
        const variations = ['\uFE00', '\uFE01', '\uFE02', '\uFE0E', '\uFE0F'];
        
        // Invisible separators
        const invisibleSeparators = [
            '\u2060', // Word Joiner
            '\u2063', // Invisible Separator
            '\uFEFF', // Zero Width No-Break Space
            '\u180E', // Mongolian Vowel Separator
        ];
        
        // Load saved watermark text
        function loadWatermarkText() {
            const saved = localStorage.getItem('watermarkText');
            if (saved) {
                document.getElementById('watermark-text').value = saved;
            }
        }
        
        // Save watermark text
        function saveWatermarkText(text) {
            localStorage.setItem('watermarkText', text);
        }
        
        function encodeWatermark(text) {
            let encoded = text;
            
            // Chỉ dùng các phương pháp VÔ HÌNH - text đọc được bình thường
            
            // 1. Add Zero-width characters
            const zwChars = Object.values(zeroWidth);
            encoded = encoded.split('').map((char, i) => {
                if (i > 0 && Math.random() > 0.3) {
                    const zw = zwChars[Math.floor(Math.random() * zwChars.length)];
                    return zw + char;
                }
                return char;
            }).join('');
            
            // 2. Add Invisible separators
            encoded = encoded.split('').map((char, i) => {
                if (i > 0 && i < encoded.length - 1 && Math.random() > 0.5) {
                    const sep = invisibleSeparators[Math.floor(Math.random() * invisibleSeparators.length)];
                    return char + sep;
                }
                return char;
            }).join('');
            
            // 3. Add random whitespace variations
            const spaceVariations = [
                '\u0020', // Normal space
                '\u00A0', // Non-breaking space
                '\u2002', // En space
                '\u2003', // Em space
                '\u2009', // Thin space
                '\u200A', // Hair space
            ];
            encoded = encoded.split(' ').map((word, i) => {
                if (i > 0) {
                    const space = spaceVariations[Math.floor(Math.random() * spaceVariations.length)];
                    return space + word;
                }
                return word;
            }).join('');
            
            // 4. Add Unicode variations
            encoded = encoded.split('').map((char, i) => {
                if (Math.random() > 0.6) {
                    const variant = variations[Math.floor(Math.random() * variations.length)];
                    return char + variant;
                }
                return char;
            }).join('');
            
            return encoded;
        }
        
        function addWatermarkAuto() {
            const output = document.getElementById('output');
            const watermarkText = document.getElementById('watermark-text').value.trim();
            const watermarkCount = parseInt(document.getElementById('watermark-count').value);
            
            if (!output.value.trim()) {
                return;
            }
            
            if (!watermarkText) {
                showStatusWatermark('Vui lòng nhập nội dung watermark', 'info');
                return;
            }
            
            saveWatermarkText(watermarkText);
            
            const lines = output.value.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                showStatusWatermark('Văn bản cần có ít nhất 2 dòng để chèn watermark', 'info');
                return;
            }
            
            const maxWatermarks = lines.length - 1;
            const actualCount = Math.min(watermarkCount, maxWatermarks);
            
            if (actualCount < watermarkCount) {
                showStatusWatermark(`Văn bản chỉ có ${lines.length} dòng, chỉ có thể chèn tối đa ${maxWatermarks} watermark`, 'info');
            }
            
            const availablePositions = Array.from({length: maxWatermarks}, (_, i) => i + 1);
            const selectedPositions = [];
            
            for (let i = 0; i < actualCount; i++) {
                const randomIndex = Math.floor(Math.random() * availablePositions.length);
                selectedPositions.push(availablePositions[randomIndex]);
                availablePositions.splice(randomIndex, 1);
            }
            
            selectedPositions.sort((a, b) => a - b);
            
            let result = [];
            let watermarkIndex = 0;
            
            for (let i = 0; i < lines.length; i++) {
                result.push(lines[i]);
                
                if (watermarkIndex < selectedPositions.length && 
                    selectedPositions[watermarkIndex] === i + 1) {
                    const encodedWatermark = encodeWatermark(watermarkText);
                    result.push(encodedWatermark);
                    watermarkIndex++;
                }
            }
            
            output.value = result.join('\n');
            showStatusWatermark(`Đã chèn ${actualCount} watermark vào văn bản`, 'success');
        }
        
        function addWatermark() {
            addWatermarkAuto();
        }
        
        function showStatusWatermark(message, type) {
            const status = document.getElementById('status-watermark');
            status.innerHTML = message;
            status.className = `status ${type}`;
            
            setTimeout(() => {
                status.innerHTML = '';
                status.className = '';
            }, 3000);
        }
        
        // ======= ORIGINAL FUNCTIONS =======
        
        function fixText() {
            const input = document.getElementById('input').value;
            const output = document.getElementById('output');
            const status = document.getElementById('status');
            const changesLog = document.getElementById('changes-log');
            const changesContent = document.getElementById('changes-content');
            
            if (!input.trim()) {
                showStatus('Vui lòng nhập văn bản cần sửa!', 'info');
                changesLog.style.display = 'none';
                return;
            }
            
            let fixedText = input;
            let changesCount = 0;
            let changesList = [];
            
            const removeRegex = /[TtŤťṪṫṬṭṮṯṰṱŢţẗŦŧƭƬȚțŤťṬṭṰṱ][UuÚúÙùÛûÜüŨũŪūŬŭŮůŲųỤụỦủṲṳṴṵṶṷṸṹṺṻŰűŮůū́ŭų][\u0300-\u036F]*[\u2070-\u209F₀-₉ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥwₓᵧᶻ⁰-⁹¹²³⁴⁵⁶⁷⁸⁹ᵃ-ᶻ⁺⁻⁼⁽⁾₊₋₌₍₎]+/g;
            
            let match;
            let removedCount = 0;
            
            while ((match = removeRegex.exec(input)) !== null) {
                removedCount++;
                const beforeMatch = input.substring(0, match.index);
                const lineNumber = beforeMatch.split('\n').length;
                const lineStart = beforeMatch.lastIndexOf('\n') + 1;
                const columnNumber = match.index - lineStart + 1;
                const start = Math.max(0, match.index - 5);
                const end = Math.min(input.length, match.index + match[0].length + 5);
                const context = input.substring(start, end);
                const contextHighlighted = context.replace(match[0], `<mark style="background: #ff5722; color: white; font-weight: bold;">${match[0]}</mark>`);
                
                changesList.push({
                    type: 'remove',
                    broken: match[0],
                    correct: '[XÓA]',
                    line: lineNumber,
                    column: columnNumber,
                    context: contextHighlighted,
                    position: match.index
                });
                
                removeRegex.lastIndex = match.index + 1;
            }
            
            fixedText = fixedText.replace(/[TtŤťṪṫṬṭṮṯṰṱŢţẗŦŧƭƬȚțŤťṬṭṰṱ][UuÚúÙùÛûÜüŨũŪūŬŭŮůŲųỤụỦủṲṳṴṵṶṷṸṹṺṻŰűŮůū́ŭų][\u0300-\u036F]*[\u2070-\u209F₀-₉ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥwₓᵧᶻ⁰-⁹¹²³⁴⁵⁶⁷⁸⁹ᵃ-ᶻ⁺⁻⁼⁽⁾₊₋₌₍₎]+/g, '');
            changesCount += removedCount;
            
            for (const [broken, correct] of Object.entries(charMap)) {
                const regex = new RegExp(broken, 'g');
                let matchChar;
                
                while ((matchChar = regex.exec(fixedText)) !== null) {
                    changesCount++;
                    const beforeMatch = fixedText.substring(0, matchChar.index);
                    const lineNumber = beforeMatch.split('\n').length;
                    const lineStart = beforeMatch.lastIndexOf('\n') + 1;
                    const columnNumber = matchChar.index - lineStart + 1;
                    const start = Math.max(0, matchChar.index - 5);
                    const end = Math.min(fixedText.length, matchChar.index + 6);
                    const context = fixedText.substring(start, end);
                    const contextHighlighted = context.replace(broken, `<mark style="background: #ffeb3b; color: #d32f2f; font-weight: bold;">${broken}</mark>`);
                    
                    changesList.push({
                        type: 'replace',
                        broken: broken,
                        correct: correct,
                        line: lineNumber,
                        column: columnNumber,
                        context: contextHighlighted,
                        position: matchChar.index
                    });
                    
                    regex.lastIndex = matchChar.index + 1;
                }
                
                fixedText = fixedText.replace(new RegExp(broken, 'g'), correct);
            }
            
            output.value = fixedText;
            
            if (changesCount > 0) {
                changesList.sort((a, b) => {
                    if (a.type !== b.type) {
                        return a.type === 'remove' ? -1 : 1;
                    }
                    return a.position - b.position;
                });
                
                let changesHtml = `<div style="margin-bottom: 10px;"><strong>Tổng cộng: ${changesCount} thay đổi (${removedCount} xóa, ${changesCount - removedCount} thay thế)</strong></div>`;
                
                changesList.forEach((change, index) => {
                    const isRemove = change.type === 'remove';
                    const bgColor = isRemove ? '#ffebee' : '#e3f2fd';
                    const borderColor = isRemove ? '#f44336' : '#667eea';
                    const actionIcon = isRemove ? 'XÓA' : 'THAY';
                    
                    changesHtml += `
                        <div style="border-left: 3px solid ${borderColor}; padding-left: 10px; margin-bottom: 10px; background: ${bgColor}; border-radius: 0 5px 5px 0;">
                            <div style="color: #666; font-size: 12px; margin-bottom: 5px;">
                                ${actionIcon} #${index + 1} • Dòng ${change.line}, cột ${change.column}
                            </div>
                            <div style="margin-bottom: 5px;">
                                <span style="color: ${isRemove ? '#d32f2f' : '#d32f2f'}; background: ${isRemove ? '#ffcdd2' : '#ffebee'}; padding: 2px 6px; border-radius: 3px; font-weight: bold;">${change.broken}</span>
                                <span style="margin: 0 8px; color: #666;">→</span>
                                <span style="color: ${isRemove ? '#d32f2f' : '#2e7d32'}; background: ${isRemove ? '#ffcdd2' : '#e8f5e8'}; padding: 2px 6px; border-radius: 3px; font-weight: bold;">${change.correct}</span>
                            </div>
                            <div style="color: #555; font-size: 13px;">
                                <strong>Context:</strong> ${change.context}
                            </div>
                        </div>
                    `;
                });
                
                changesContent.innerHTML = changesHtml;
                changesLog.style.display = 'block';
                
                showStatus(`Đã xử lý ${changesCount} thay đổi (${removedCount} xóa ký tự thừa, ${changesCount - removedCount} sửa encoding)`, 'success');
            } else {
                changesLog.style.display = 'none';
                showStatus('Không tìm thấy ký tự nào cần sửa', 'info');
            }
            
            setTimeout(() => {
                addWatermarkAuto();
            }, 100);
        }
        
        function clearText() {
            document.getElementById('input').value = '';
            document.getElementById('output').value = '';
            document.getElementById('status').innerHTML = '';
            document.getElementById('status-watermark').innerHTML = '';
            document.getElementById('changes-log').style.display = 'none';
        }
        
        function copyResult() {
            const output = document.getElementById('output');
            if (!output.value.trim()) {
                showStatus('Không có nội dung để copy!', 'info');
                return;
            }
            
            output.select();
            output.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showStatus('Đã copy kết quả vào clipboard', 'success');
            } catch (err) {
                navigator.clipboard.writeText(output.value).then(() => {
                    showStatus('Đã copy kết quả vào clipboard', 'success');
                }).catch(() => {
                    showStatus('Không thể copy. Vui lòng copy thủ công', 'info');
                });
            }
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.innerHTML = message;
            status.className = `status ${type}`;
            
            setTimeout(() => {
                status.innerHTML = '';
                status.className = '';
            }, 3000);
        }
        
        document.getElementById('input').addEventListener('input', function() {
            clearTimeout(this.timeout);
            this.timeout = setTimeout(() => {
                if (this.value.trim()) {
                    fixText();
                }
            }, 500);
        });
        
        window.addEventListener('DOMContentLoaded', function() {
            loadWatermarkText();
        });
        
        document.getElementById('watermark-text').addEventListener('input', function() {
            saveWatermarkText(this.value);
        });
    </script>
</body>
</html>
