<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ sửa lỗi encoding văn bản</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .buttons {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .clear-btn {
            background: linear-gradient(45deg, #e53e3e, #c53030);
        }
        
        .copy-btn {
            background: linear-gradient(45deg, #38a169, #2f855a);
        }
        
        .status {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: 600;
        }
        
        .success {
            background: #c6f6d5;
            color: #2f855a;
            border: 1px solid #9ae6b4;
        }
        
        .info {
            background: #bee3f8;
            color: #2b6cb0;
            border: 1px solid #90cdf4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Công cụ sửa lỗi encoding văn bản</h1>
        
        <div class="input-group">
            <label for="input">Nhập văn bản cần sửa:</label>
            <textarea id="input" placeholder="Dán văn bản có lỗi encoding vào đây..."></textarea>
        </div>
        
        <div class="buttons">
            <button onclick="fixText()">🔧 Sửa lỗi encoding</button>
            <button onclick="clearText()" class="clear-btn">🗑️ Xóa</button>
            <button onclick="copyResult()" class="copy-btn">📋 Copy kết quả</button>
        </div>
        
        <div class="input-group">
            <label for="output">Kết quả sau khi sửa:</label>
            <textarea id="output" readonly placeholder="Kết quả sẽ hiển thị ở đây..."></textarea>
        </div>
        
        <div id="status"></div>
        
        <div id="changes-log" style="display: none;">
            <div class="input-group">
                <label>📋 Chi tiết thay đổi:</label>
                <div id="changes-content" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 14px;"></div>
            </div>
        </div>
    </div>

    <script>
        // Bản đồ các ký tự bị lỗi encoding - chỉ những ký tự trông giống chữ gốc
        const charMap = {
            // Các ký tự phổ biến bị lỗi encoding
            '⼉': '儿',  // con
            '⻝': '食',  // thức ăn
            '⼦': '子',  // con trai  
            '⻔': '门',  // cửa
            '⽤': '用',  // dùng
            '⽅': '方',  // phương
            '⼜': '又',  // lại
            '⼀': '一',  // một
            '⼗': '十',  // mười
            '⼤': '大',  // lớn
            '⼈': '人',  // người
            '⼊': '入',  // vào
            '⼋': '八',  // tám
            '⼒': '力',  // sức mạnh
            '⼑': '刀',  // dao
            '⼥': '女',  // nữ
            '⼩': '小',  // nhỏ
            '⼯': '工',  // công
            '⼰': '己',  // bản thân
            '⼱': '巾',  // khăn
            '⼲': '干',  // khô
            '⼴': '广',  // rộng
            '⼸': '弓',  // cung
            '⼼': '心',  // tim
            '⼿': '手',  // tay
            '⽀': '支',  // chi nhánh
            '⽂': '文',  // văn
            '⽇': '日',  // ngày
            '⽉': '月',  // tháng
            '⽊': '木',  // gỗ
            '⽔': '水',  // nước
            '⽕': '火',  // lửa
            '⽗': '父',  // cha
            '⽚': '片',  // mảnh
            '⽛': '牙',  // răng
            '⽜': '牛',  // bò
            '⽝': '犬',  // chó
            '⽟': '玉',  // ngọc
            '⽡': '瓦',  // ngói
            '⽢': '甘',  // ngọt
            '⽣': '生',  // sinh
            '⽥': '田',  // ruộng
            '⽩': '白',  // trắng
            '⽪': '皮',  // da
            '⽫': '皿',  // đĩa
            '⽬': '目',  // mắt
            '⽯': '石',  // đá
            '⽰': '示',  // chỉ
            '⽲': '禾',  // lúa
            '⽳': '穴',  // lỗ
            '⽴': '立',  // đứng
            '⽵': '竹',  // tre
            '⽶': '米',  // gạo
            '⽷': '糸',  // tơ
            '⽹': '网',  // mạng
            '⽺': '羊',  // cừu
            '⽻': '羽',  // lông
            '⽼': '老',  // già
            '⽽': '而',  // mà
            '⽿': '耳',  // tai
            '⾁': '肉',  // thịt
            '⾂': '臣',  // thần
            '⾃': '自',  // tự
            '⾄': '至',  // đến
            '⾆': '舌',  // lưỡi
            '⾈': '舟',  // thuyền
            '⾊': '色',  // màu
            '⾍': '虫',  // côn trúng
            '⾎': '血',  // máu
            '⾏': '行',  // hành
            '⾐': '衣',  // quần áo
            '⾓': '角',  // góc
            '⾔': '言',  // nói
            '⾕': '谷',  // thung lũng
            '⾖': '豆',  // đậu
            '⾙': '贝',  // vỏ sò
            '⾚': '赤',  // đỏ
            '⾛': '走',  // chạy
            '⾜': '足',  // chân
            '⾝': '身',  // thân
            '⾞': '车',  // xe
            '⾟': '辛',  // cay
            '⾨': '门',  // cửa
            '⾦': '金',  // vàng
            '⾧': '长',  // dài
            '⾬': '雨',  // mưa
            '⾮': '非',  // phi
            '⾯': '面',  // mặt
            '⾷': '食',  // ăn
            '⾸': '首',  // đầu
            '⾹': '香',  // thơm
            '⾻': '骨',  // xương
            '⾼': '高',  // cao
            '⾥': '里',  // trong/dặm
            '⽆': '无',  // không có
            '⻢': '马',  // mã
            '⻅': '见',  // thấy
            '⻆': '角',  // góc
            '⻩': '黄',   // vàng (simplified)
        };
        
        function fixText() {
            const input = document.getElementById('input').value;
            const output = document.getElementById('output');
            const status = document.getElementById('status');
            const changesLog = document.getElementById('changes-log');
            const changesContent = document.getElementById('changes-content');
            
            if (!input.trim()) {
                showStatus('Vui lòng nhập văn bản cần sửa!', 'info');
                changesLog.style.display = 'none';
                return;
            }
            
            let fixedText = input;
            let changesCount = 0;
            let changesList = [];
            
            // BƯỚC 1: Xóa ký tự thừa theo regex (sẽ hiển thị ở đầu)
            const removeRegex = /[TtŤťṪṫṬṭṮṯṰṱŢţẗŦŧƭƬȚțŤťṬṭṰṱ][UuÚúÙùÛûÜüŨũŪūŬŭŮůŲųỤụỦủṲṳṴṵṶṷṸṹṺṻŰűŮůū́ŭų][\u0300-\u036F]*[\u2070-\u209F₀-₉ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥwₓᵧᶻ⁰-⁹¹²³⁴⁵⁶⁷⁸⁹ᵃ-ᶻ⁺⁻⁼⁽⁾₊₋₌₍₎]+/g;
            
            let match;
            let removedCount = 0;
            
            // Tìm và ghi lại tất cả ký tự thừa trước khi xóa
            while ((match = removeRegex.exec(input)) !== null) {
                removedCount++;
                
                // Tính vị trí
                const beforeMatch = input.substring(0, match.index);
                const lineNumber = beforeMatch.split('\n').length;
                const lineStart = beforeMatch.lastIndexOf('\n') + 1;
                const columnNumber = match.index - lineStart + 1;
                
                // Context
                const start = Math.max(0, match.index - 5);
                const end = Math.min(input.length, match.index + match[0].length + 5);
                const context = input.substring(start, end);
                const contextHighlighted = context.replace(match[0], `<mark style="background: #ff5722; color: white; font-weight: bold;">${match[0]}</mark>`);
                
                changesList.push({
                    type: 'remove',
                    broken: match[0],
                    correct: '[XÓA]',
                    line: lineNumber,
                    column: columnNumber,
                    context: contextHighlighted,
                    position: match.index
                });
                
                removeRegex.lastIndex = match.index + 1;
            }
            
            // Thực hiện xóa ký tự thừa
            fixedText = fixedText.replace(/[TtŤťṪṫṬṭṮṯṰṱŢţẗŦŧƭƬȚțŤťṬṭṰṱ][UuÚúÙùÛûÜüŨũŪūŬŭŮůŲųỤụỦủṲṳṴṵṶṷṸṹṺṻŰűŮůū́ŭų][\u0300-\u036F]*[\u2070-\u209F₀-₉ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥwₓᵧᶻ⁰-⁹¹²³⁴⁵⁶⁷⁸⁹ᵃ-ᶻ⁺⁻⁼⁽⁾₊₋₌₍₎]+/g, '');
            changesCount += removedCount;
            
            // BƯỚC 2: Thay thế các ký tự bị lỗi encoding
            for (const [broken, correct] of Object.entries(charMap)) {
                const regex = new RegExp(broken, 'g');
                let matchChar;
                
                // Tìm trong văn bản đã xóa ký tự thừa
                while ((matchChar = regex.exec(fixedText)) !== null) {
                    changesCount++;
                    
                    // Tính vị trí (cần tính lại do đã xóa ký tự thừa)
                    const beforeMatch = fixedText.substring(0, matchChar.index);
                    const lineNumber = beforeMatch.split('\n').length;
                    const lineStart = beforeMatch.lastIndexOf('\n') + 1;
                    const columnNumber = matchChar.index - lineStart + 1;
                    
                    // Context trong văn bản đã xóa ký tự thừa
                    const start = Math.max(0, matchChar.index - 5);
                    const end = Math.min(fixedText.length, matchChar.index + 6);
                    const context = fixedText.substring(start, end);
                    const contextHighlighted = context.replace(broken, `<mark style="background: #ffeb3b; color: #d32f2f; font-weight: bold;">${broken}</mark>`);
                    
                    changesList.push({
                        type: 'replace',
                        broken: broken,
                        correct: correct,
                        line: lineNumber,
                        column: columnNumber,
                        context: contextHighlighted,
                        position: matchChar.index
                    });
                    
                    regex.lastIndex = matchChar.index + 1;
                }
                
                // Thực hiện thay thế
                fixedText = fixedText.replace(new RegExp(broken, 'g'), correct);
            }
            
            output.value = fixedText;
            
            if (changesCount > 0) {
                // Sắp xếp: ký tự bị xóa trước, ký tự thay thế sau
                changesList.sort((a, b) => {
                    if (a.type !== b.type) {
                        return a.type === 'remove' ? -1 : 1;
                    }
                    return a.position - b.position;
                });
                
                // Hiển thị chi tiết thay đổi
                let changesHtml = `<div style="margin-bottom: 10px;"><strong>🔄 Tổng cộng: ${changesCount} thay đổi (${removedCount} xóa, ${changesCount - removedCount} thay thế)</strong></div>`;
                
                changesList.forEach((change, index) => {
                    const isRemove = change.type === 'remove';
                    const bgColor = isRemove ? '#ffebee' : '#e3f2fd';
                    const borderColor = isRemove ? '#f44336' : '#667eea';
                    const actionIcon = isRemove ? '🗑️' : '🔄';
                    
                    changesHtml += `
                        <div style="border-left: 3px solid ${borderColor}; padding-left: 10px; margin-bottom: 10px; background: ${bgColor}; border-radius: 0 5px 5px 0;">
                            <div style="color: #666; font-size: 12px; margin-bottom: 5px;">
                                ${actionIcon} #${index + 1} • Dòng ${change.line}, cột ${change.column} • Vị trí ${change.position}
                            </div>
                            <div style="margin-bottom: 5px;">
                                <span style="color: ${isRemove ? '#d32f2f' : '#d32f2f'}; background: ${isRemove ? '#ffcdd2' : '#ffebee'}; padding: 2px 6px; border-radius: 3px; font-weight: bold;">${change.broken}</span>
                                <span style="margin: 0 8px; color: #666;">→</span>
                                <span style="color: ${isRemove ? '#d32f2f' : '#2e7d32'}; background: ${isRemove ? '#ffcdd2' : '#e8f5e8'}; padding: 2px 6px; border-radius: 3px; font-weight: bold;">${change.correct}</span>
                            </div>
                            <div style="color: #555; font-size: 13px;">
                                <strong>Context:</strong> ${change.context}
                            </div>
                        </div>
                    `;
                });
                
                changesContent.innerHTML = changesHtml;
                changesLog.style.display = 'block';
                
                showStatus(`✅ Đã xử lý ${changesCount} thay đổi (${removedCount} xóa ký tự thừa, ${changesCount - removedCount} sửa encoding)!`, 'success');
            } else {
                changesLog.style.display = 'none';
                showStatus('ℹ️ Không tìm thấy ký tự nào cần sửa.', 'info');
            }
        }
        
        function clearText() {
            document.getElementById('input').value = '';
            document.getElementById('output').value = '';
            document.getElementById('status').innerHTML = '';
            document.getElementById('changes-log').style.display = 'none';
        }
        
        function copyResult() {
            const output = document.getElementById('output');
            if (!output.value.trim()) {
                showStatus('Không có nội dung để copy!', 'info');
                return;
            }
            
            output.select();
            output.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showStatus('📋 Đã copy kết quả vào clipboard!', 'success');
            } catch (err) {
                // Fallback cho các trình duyệt hiện đại
                navigator.clipboard.writeText(output.value).then(() => {
                    showStatus('📋 Đã copy kết quả vào clipboard!', 'success');
                }).catch(() => {
                    showStatus('❌ Không thể copy. Vui lòng copy thủ công.', 'info');
                });
            }
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.innerHTML = message;
            status.className = `status ${type}`;
            
            // Tự động ẩn sau 3 giây
            setTimeout(() => {
                status.innerHTML = '';
                status.className = '';
            }, 3000);
        }
        
        // Tự động sửa khi người dùng nhập
        document.getElementById('input').addEventListener('input', function() {
            // Debounce để tránh xử lý quá nhiều
            clearTimeout(this.timeout);
            this.timeout = setTimeout(() => {
                if (this.value.trim()) {
                    fixText();
                }
            }, 500);
        });
    </script>
</body>
</html>
