<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Name Extractor ‚Äì TruyenWikiDich</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }
    h1 {
      text-align: center;
      color: #4a5568;
      margin-bottom: 10px;
      font-size: 2.5em;
    }
    .subtitle {
      text-align: center;
      color: #718096;
      margin-bottom: 30px;
      font-style: italic;
    }
    .section {
      margin-bottom: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    input[type="text"] { 
      width: 100%; 
      padding: 12px; 
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }
    textarea { 
      width: 100%; 
      height: 150px; 
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      resize: vertical;
      transition: border-color 0.3s;
    }
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    button { 
      padding: 12px 24px; 
      margin: 10px 5px 10px 0; 
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .status {
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: 500;
    }
    .status.success {
      background: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }
    .status.error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }
    .status.info {
      background: #bee3f8;
      color: #2a4365;
      border: 1px solid #90cdf4;
    }
    .preview {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.4;
    }
    .count {
      font-weight: bold;
      color: #667eea;
    }
    .bookmarklet {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      word-break: break-all;
      margin-top: 10px;
    }
    .instruction {
      background: #fff5cd;
      border: 1px solid #f6e05e;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Name Extractor</h1>
    <p class="subtitle">Tr√≠ch xu·∫•t v√† t·∫£i danh s√°ch t√™n nh√¢n v·∫≠t t·ª´ TruyenWikiDich m·ªôt c√°ch t·ª± ƒë·ªông</p>

    <div class="instruction">
      <strong>üìù H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:</strong>
      <ol>
        <li>Truy c·∫≠p trang Wiki c·ªßa truy·ªán</li>
        <li>Nh·∫•n v√†o n√∫t "Tr√≠ch xu·∫•t t·ª´ trang hi·ªán t·∫°i" khi ƒëang ·ªü trang ƒë√≥</li>
        <li>Ho·∫∑c nh·∫≠p link trang Wiki v√†o √¥ b√™n d∆∞·ªõi</li>
        <li>File s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫£i v·ªÅ!</li>
      </ol>
    </div>

    <div class="section">
      <h2>üéØ Tr√≠ch xu·∫•t t·ª± ƒë·ªông</h2>
      <input id="linkInput" type="text" placeholder="Nh·∫≠p link trang Wiki c·ªßa truy·ªán..." />
      <br>
      <button id="autoBtn">üì• Tr√≠ch xu·∫•t t·ª´ link</button>
    </div>



    <div class="section">
      <h2>üíæ K·∫øt qu·∫£ v√† t·∫£i v·ªÅ</h2>
      <input id="fileName" type="text" placeholder="T√™n file (t·ª± ƒë·ªông t·∫°o t·ª´ ti√™u ƒë·ªÅ trang)" />
      <br>
      <button id="downloadBtn" disabled>üìÅ T·∫£i xu·ªëng file TXT</button>
      <div id="status"></div>
      <div id="preview" class="preview" style="display: none;"></div>
    </div>

    <div class="section">
      <h2>üîñ Bookmarklet (D√†nh cho cao th·ªß)</h2>
      <p>K√©o th·∫£ link n√†y v√†o thanh bookmark ƒë·ªÉ s·ª≠ d·ª•ng tr√™n b·∫•t k·ª≥ trang n√†o:</p>
      <div class="bookmarklet">
        <a href="javascript:(()=>{try{let m=document.getElementById('mdListName');if(!m)return alert('‚ùå Kh√¥ng th·∫•y n·ªôi dung.');let l=m.innerText.split('\n').map(x=>x.trim()).filter(x=>x.includes('=')&&!/(t·ªïng s·ªë|l·ªãch s·ª≠|ƒë√≥ng|total|history|close)/i.test(x)&&x.length>0);if(!l.length)return alert('‚ùå Kh√¥ng c√≥ d√≤ng h·ª£p l·ªá.');let t=document.title.replace(/[\\/:*?\"<>|]+/g,'_'),f=`name2_${t}.txt`,b=new Blob([l.join('\n')],{type:'text/plain'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=f;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);alert('‚úÖ ƒê√£ t·∫£i '+l.length+' t√™n!')}catch(e){alert('‚ùå L·ªói: '+e.message)}})()">
          üìö Name Extractor Bookmarklet
        </a>
      </div>
    </div>
  </div>

  <script>
    let extractedNames = [];
    let currentFileName = '';

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      setTimeout(() => {
        if (type !== 'success') statusDiv.innerHTML = '';
      }, 5000);
    }

    function extractNamesFromWikiContent(content) {
      // T√¨m element c√≥ id="mdListName" trong HTML
      const parser = new DOMParser();
      const doc = parser.parseFromString(content, 'text/html');
      const mdListName = doc.getElementById('mdListName');
      
      if (!mdListName) {
        throw new Error('Kh√¥ng t√¨m th·∫•y element #mdListName trong trang');
      }

      // L·∫•y text content v√† x·ª≠ l√Ω ƒë·ªÉ l·∫•y format "ÂéüÊñá=Ti·∫øng Vi·ªát"
      const lines = mdListName.innerText
        .split('\n')
        .map(x => x.trim())
        .filter(x => {
          // L·ªçc c√°c d√≤ng c√≥ d·∫•u = v√† kh√¥ng ch·ª©a c√°c t·ª´ lo·∫°i tr·ª´
          return x.includes('=') && 
                 !/(t·ªïng s·ªë|l·ªãch s·ª≠|ƒë√≥ng|total|history|close)/i.test(x) &&
                 x.length > 0;
        });

      if (!lines.length) {
        throw new Error('Kh√¥ng c√≥ d√≤ng h·ª£p l·ªá n√†o ƒë∆∞·ª£c t√¨m th·∫•y');
      }

      return lines;
    }



    function generateFileName(title = '') {
      const cleanTitle = title || document.title || 'TruyenWiki';
      return `name2_${cleanTitle.replace(/[\\/:*?"<>|]+/g, '_')}.txt`;
    }

    function updatePreview(names) {
      const preview = document.getElementById('preview');
      const downloadBtn = document.getElementById('downloadBtn');
      
      if (names.length > 0) {
        preview.style.display = 'block';
        preview.innerHTML = `<strong class="count">T√¨m th·∫•y ${names.length} t√™n:</strong><br><br>` + 
                           names.slice(0, 20).join('<br>') + 
                           (names.length > 20 ? '<br><br>... v√† ' + (names.length - 20) + ' t√™n kh√°c' : '');
        downloadBtn.disabled = false;
        extractedNames = names;
        showStatus(`‚úÖ Tr√≠ch xu·∫•t th√†nh c√¥ng ${names.length} t√™n!`, 'success');
      } else {
        preview.style.display = 'none';
        downloadBtn.disabled = true;
        extractedNames = [];
        showStatus('‚ùå Kh√¥ng t√¨m th·∫•y t√™n n√†o!', 'error');
      }
    }

    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Tr√≠ch xu·∫•t t·ª´ link
    document.getElementById('autoBtn').addEventListener('click', async () => {
      const link = document.getElementById('linkInput').value.trim();
      if (!link) {
        showStatus('‚ùå Vui l√≤ng nh·∫≠p link trang truy·ªán!', 'error');
        return;
      }

      showStatus('üîÑ ƒêang t·∫£i trang...', 'info');
      
      try {
        // Th·ª≠ nhi·ªÅu c√°ch ƒë·ªÉ tr√°nh CORS
        let response;
        let content;
        
        // C√°ch 1: Th·ª≠ fetch tr·ª±c ti·∫øp
        try {
          response = await fetch(link);
          content = await response.text();
        } catch (corsError) {
          // C√°ch 2: S·ª≠ d·ª•ng proxy kh√°c
          try {
            const proxyUrl = `https://cors-anywhere.herokuapp.com/${link}`;
            response = await fetch(proxyUrl);
            content = await response.text();
          } catch (proxyError) {
            // C√°ch 3: S·ª≠ d·ª•ng allorigins
            const allOriginsUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(link)}`;
            response = await fetch(allOriginsUrl);
            const data = await response.json();
            content = data.contents;
          }
        }
        
        if (!content) {
          throw new Error('Kh√¥ng th·ªÉ t·∫£i n·ªôi dung trang');
        }

        const names = extractNamesFromWikiContent(content);
        
        // T·∫°o t√™n file t·ª´ ti√™u ƒë·ªÅ trang
        const parser = new DOMParser();
        const doc = parser.parseFromString(content, 'text/html');
        const title = doc.title || 'TruyenWiki';
        currentFileName = generateFileName(title);
        document.getElementById('fileName').value = currentFileName;
        
        updatePreview(names);
        
      } catch (error) {
        console.error('Error:', error);
        showStatus(`‚ùå L·ªói: ${error.message}`, 'error');
      }
    });





    // T·∫£i xu·ªëng file
    document.getElementById('downloadBtn').addEventListener('click', () => {
      if (extractedNames.length === 0) {
        showStatus('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i xu·ªëng!', 'error');
        return;
      }

      let filename = document.getElementById('fileName').value.trim();
      if (!filename) {
        filename = currentFileName || 'names.txt';
      } else if (!filename.endsWith('.txt')) {
        filename += '.txt';
      }

      downloadFile(filename, extractedNames.join('\n'));
      showStatus(`üéâ ƒê√£ t·∫£i xu·ªëng file "${filename}" v·ªõi ${extractedNames.length} t√™n!`, 'success');
    });

    // T·ª± ƒë·ªông focus v√†o input ƒë·∫ßu ti√™n
    document.getElementById('linkInput').focus();
  </script>
</body>
</html>
